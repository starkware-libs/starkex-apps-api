{
    "openrpc": "1.2.4",
    "info": {
        "title": "StarkEx Perpetual Application API",
        "description": "A specification of a standard interface for applications using StarkEx Perpetual",
        "version": "0.1.0"
    },
    "methods": [
        {
            "name": "starkex_subscribe",
            "description": "Subscribe to a stream of events",
            "params": [
                {
                    "name": "requested_transaction_types",
                    "required": false,
                    "description": "The events the client wishes to listen to",
                    "schema": {
                        "type": "array",
                        "items": {
                            "$ref": "#/components/schemas/TXN_TYPE"
                        }
                    }
                },
                {
                    "name": "requested_statuses",
                    "required": false,
                    "description": "The transaction statuses the client would like to listen to",
                    "schema": {
                        "type": "array",
                        "items": {
                            "$ref": "#/components/schemas/PROCESSING_STATUS"
                        }
                    }
                },
                {
                    "name": "start_from",
                    "required": false,
                    "description": "The earliest timestamp for events to retrieve on the stream. A UTC timestamp, default to now.",
                    "schema": {
                        "$ref": "#/components/schemas/TIMESTAMP"
                    }
                }
            ],
            "result": {
                "name": "result",
                "description": "The subscription id",
                "schema": {
                    "type": "string"
                }
            },
            "errors": [
                {
                    "$ref": "#/components/errors/SUBSCRIPTION_UNSUCCESSFUL"
                }
            ]
        },
        {
            "name": "starkex_unsubscribe",
            "description": "Unsubscribe from a given event stream",
            "params": [
                {
                    "name": "subscription_id",
                    "description": "The subscription id, as returned from the subscribe method",
                    "required": true,
                    "schema": {
                        "type": "string"
                    }
                }
            ],
            "result": {
                "name": "result",
                "schema": {
                    "type": "boolean",
                    "description": "Returns true if the subscription was cancelled successfully"
                }
            }
        }
    ],
    "components": {
        "schemas": {
            "TXN_TYPE": {
                "anyOf": [
                    {
                        "type": "string",
                        "enum": [
                            "DEPOSIT",
                            "WITHDRAWAL",
                            "WITHDRAWAL_TO_ADDR",
                            "FORCED_WITHDRAWAL",
                            "TRADE",
                            "FORCED_TRADE"
                        ]
                    },
                    {
                        "$comment": "Allow future transaction types to be added and pass validation",
                        "type": "string"
                    }
                ]
            },
            "ORDER": {
                "type": "object",
                "properties": {
                    "type": {
                        "enum": [
                            "LIMIT_ORDER_WITH_FEES"
                        ]
                    },
                    "nonce": {
                        "description": "Unique nonce issued by the caller",
                        "$ref": "#/components/schemas/NONCE"
                    },
                    "public_key": {
                        "description": "Public key of the party as registered on the StarkEx contract",
                        "$ref": "#/components/schemas/STARK_KEY"
                    },
                    "amount_synthetic": {
                        "description": "Amount of synthetic asset in the order",
                        "$ref": "#/components/schemas/AMOUNT"
                    },
                    "amount_collateral": {
                        "description": "Amount of collateral asset in the order",
                        "$ref": "#/components/schemas/AMOUNT"
                    },
                    "asset_id_synthetic": {
                        "description": "The synthetic asset ID (as registered on the contract)",
                        "$ref": "#/components/schemas/ASSET_ID"
                    },
                    "asset_id_collateral": {
                        "description": "The collateral asset ID (as registered on the contract)",
                        "$ref": "#/components/schemas/ASSET_ID"
                    },
                    "position_id": {
                        "description": "Position ID used for the trade",
                        "$ref": "#/components/schemas/POSITION_ID"
                    },
                    "is_buying_synthetic": {
                        "description": "A flag to indicate whether the order is for buying the synthetic amount or selling the synthetic amount",
                        "type": "boolean"
                    },
                    "fee_limit": {
                        "description": "The fee limit for this order",
                        "$ref": "#/components/schemas/AMOUNT"
                    },
                    "expiration_timestamp": {
                        "description": "The timestamp after which this request is no longer valid",
                        "$ref": "#/components/schemas/TIMESTAMP"
                    }
                }
            },
            "TRADE": {
                "$comment": "We assume that the orders are such that party a buys the synthetic asset, and party b buys the # collateral asset",
                "type": "object",
                "properties": {
                    "party_a_order": {
                        "$ref": "#/components/schemas/ORDER"
                    },
                    "party_b_order": {
                        "$ref": "#/components/schemas/ORDER"
                    },
                    "actual_collateral": {
                        "description": "The collateral amount sold in the trade",
                        "$ref": "#/components/schemas/AMOUNT"
                    },
                    "actual_synthetic": {
                        "description": "The synthetic amount sold in the trade",
                        "$ref": "#/components/schemas/POSITIVE_AMOUNT"
                    },
                    "actual_a_fees": {
                        "description": "The amount party a paid for fees out of the maximal amount they were willing to pay",
                        "$ref": "#/components/schemas/AMOUNT"
                    },
                    "actual_b_fees": {
                        "description": "The amount party b paid for fees of the maximal amount they were willing to pay",
                        "$ref": "#/components/schemas/AMOUNT"
                    }
                }
            },
            "FORCED_TRADE": {
                "type": "object",
                "properties": {
                    "public_key_party_a": {
                        "description": "Party a's public key",
                        "$ref": "#/components/schemas/STARK_KEY"
                    },
                    "public_key_party_b": {
                        "description": "Party b's public key",
                        "$ref": "#/components/schemas/STARK_KEY"
                    },
                    "position_id_party_a": {
                        "description": "The position ID of party a",
                        "$ref": "#/components/schemas/POSITION_ID"
                    },
                    "position_id_party_b": {
                        "description": "The position ID of party b",
                        "$ref": "#/components/schemas/POSITION_ID"
                    },
                    "collateral_asset_id": {
                        "description": "The collateral unique asset ID (as registered on the contract)",
                        "$ref": "#/components/schemas/COLLATERAL_ASSET_ID"
                    },
                    "synthetic_asset_id": {
                        "description": "The unique asset ID of the synthetic asset that is traded",
                        "$ref": "#/components/schemas/ASSET_ID"
                    },
                    "actual_collateral": {
                        "description": "The amount of collateral asset traded",
                        "$ref": "#/components/schemas/AMOUNT"
                    },
                    "actual_synthetic": {
                        "description": "The amount of synthetic asset traded",
                        "$ref": "#/components/schemas/AMOUNT"
                    },
                    "is_party_a_buying_synthetic": {
                        "description": "Specifies if party A is buying the synthetic asset",
                        "type": "boolean"
                    },
                    "nonce": {
                        "description": "Unique nonce issued by the caller",
                        "$ref": "#/components/schemas/NONCE"
                    },
                    "is_valid": {
                        "description": "A flag that specifies the validity of the forced action",
                        "type": "boolean"
                    }
                }
            },
            "FORCED_WITHDRAWAL_TXN": {
                "type": "object",
                "properties": {
                    "position_id": {
                        "description": "The position ID to withdraw from",
                        "type": "integer",
                        "minimum": 0
                    },
                    "public_key": {
                        "description": "The position ID owner's public key",
                        "$ref": "#/components/schemas/STARK_KEY"
                    },
                    "amount": {
                        "description": "Amount to withdraw",
                        "type": "integer",
                        "minimum": 0
                    },
                    "is_valid": {
                        "description": "A flag that specifies the validity of the forced action",
                        "type": "boolean"
                    }
                }
            },
            "WITHDRAWAL_TO_ADDR_TXN": {
                "allOf": [
                    {
                        "$ref": "#/components/schemas/WITHDRAWAL_TXN"
                    },
                    {
                        "type": "object",
                        "properties": {
                            "eth_address": {
                                "description": "The Ethereum address to move the funds into",
                                "$ref": "#/components/schemas/ETH_ADDRESS"
                            }
                        }
                    }
                ]
            },
            "WITHDRAWAL_TXN": {
                "type": "object",
                "properties": {
                    "position_id": {
                        "description": "The position ID to withdraw from",
                        "type": "integer",
                        "minimum": 0
                    },
                    "public_key": {
                        "description": "The position ID owner's public key",
                        "$ref": "#/components/schemas/STARK_KEY"
                    },
                    "amount": {
                        "description": "Amount to withdraw",
                        "type": "integer",
                        "minimum": 0
                    },
                    "nonce": {
                        "description": "Unique nonce issued by the caller",
                        "$ref": "#/components/schemas/NONCE"
                    },
                    "expiration_timestamp": {
                        "description": "The timestamp after which this request is no longer valid",
                        "$ref": "#/components/schemas/TIMESTAMP"
                    }
                }
            },
            "DEPOSIT_TXN": {
                "type": "object",
                "properties": {
                    "position_id": {
                        "description": "The position ID to deposit to",
                        "type": "integer",
                        "minimum": 0
                    },
                    "public_key": {
                        "description": "The position ID owner's public key",
                        "$ref": "#/components/schemas/STARK_KEY"
                    },
                    "amount": {
                        "description": "Amount of collateral asset to be deposited",
                        "type": "integer",
                        "minimum": 0
                    }
                }
            },
            "SINGLE_TRANSACTION": {
                "$comment": "Future transaction types should extend one of these below, with additional properties allowed. The transaction type should indicate the semantic of the object and how the client should parse it",
                "allOf": [
                    {
                        "type": "object",
                        "properties": {
                            "transaction_id": {
                                "$ref": "#/components/schemas/TXN_ID"
                            }
                        }
                    },
                    {
                        "oneOf": [
                            {
                                "$ref": "#/components/schemas/DEPOSIT_TXN"
                            },
                            {
                                "$ref": "#/components/schemas/WITHDRAWAL_TXN"
                            },
                            {
                                "$ref": "#/components/schemas/WITHDRAWAL_TO_ADDR_TXN"
                            },
                            {
                                "$ref": "#/components/schemas/FORCED_WITHDRAWAL_TXN"
                            },
                            {
                                "$ref": "#/components/schemas/TRADE"
                            },
                            {
                                "$ref": "#/components/schemas/FORCED_TRADE"
                            }
                        ]
                    }
                ]
            },
            "MULTI_TRANSACTION": {
                "type": "object",
                "properties": {
                    "transactions": {
                        "type": "array",
                        "items": {
                            "$ref": "#/components/schemas/SINGLE_TRANSACTION"
                        }
                    }
                }
            },
            "STARKEX_EVENT": {
                "type": "object",
                "properties": {
                    "time": {
                        "description": "A UTC timestamp for when the event occurred in StarkEx",
                        "$ref": "#/components/schemas/TIMESTAMP"
                    },
                    "transaction_type": {
                        "$ref": "#/components/schemas/TXN_TYPE"
                    },
                    "status": {
                        "$ref": "#/components/schemas/PROCESSING_STATUS"
                    },
                    "transaction": {
                        "anyOf": [
                            {
                                "$ref": "#/components/schemas/SINGLE_TRANSACTION"
                            },
                            {
                                "$ref": "#/components/schemas/MULTI_TRANSACTION"
                            }
                        ]
                    }
                }
            },
            "STARK_KEY": {
                "$ref": "./api/nft-apps-openrpc.json#components/schemas/STARK_KEY"
            },
            "TIMESTAMP": {
                "$ref": "./api/nft-apps-openrpc.json#components/schemas/TIMESTAMP"
            },
            "PROCESSING_STATUS": {
                "$ref": "./api/nft-apps-openrpc.json#components/schemas/PROCESSING_STATUS"
            },
            "TXN_ID": {
                "$ref": "./api/nft-apps-openrpc.json#components/schemas/TXN_ID"
            },
            "NONCE": {
                "$ref": "./api/nft-apps-openrpc.json#components/schemas/NONCE"
            },
            "ETH_ADDRESS": {
                "$ref": "./api/nft-apps-openrpc.json#components/schemas/ETH_ADDRESS"
            },
            "AMOUNT": {
                "type": "integer",
                "minimum": 0
            },
            "POSITIVE_AMOUNT": {
                "type": "integer",
                "minimum": 1
            },
            "ASSET_ID": {
                "description": "An asset id in perpetual system, 0 <= integer <= 2**120. In hex format",
                "type": "string",
                "pattern": "^0x[a-fA-F0-9]{30}$"
            },
            "COLLATERAL_ASSET_ID": {
                "description": "An asset id, 0 <= integer <= 2**250, in hex format",
                "type": "string",
                "pattern": "^0x[a-fA-F0-9]{62}$"
            },
            "POSITION_ID": {
                "description": "ID of a position. Integer, 64 bits, in hex format",
                "type": "string",
                "pattern": "^0x[a-fA-F0-9]{16}$"
            }
        },
        "errors": {
            "SUBSCRIPTION_UNSUCCESSFUL": {
                "code": 7,
                "message": "Unable to establish subscription"
            }
        }
    }
}
